<extend name="Base/base" />

<block name="page_styles">
	<link rel="stylesheet" href="__CSS__/bootstrap-datetimepicker.min.css" />
	<link rel="stylesheet" href="__CSS__/chosen.css" />
</block>

<block name="breadcrumbs">
	<include file="Base/breadcrumbs" active="填写会议信息" leaf="会议登记" url="{:U('Reception/addMeeting')}"/>
</block>

<block name="content">
	
	<div class="row">
		<div class="col-sm-12">
			<form class="form-horizontal" role="form"  method="post" action="{:U('Reception/addMeeting')}" id="meetingform">

				<div class="form-group">
					<label class="col-sm-3 control-label no-padding-right" for="type"> 会议性质:<strong class="text-danger">*</strong></label>

					<div class="col-sm-9">
						<select class="col-xs-10 col-sm-5" id="meeting_type" name="type">
							<option value=""></option>
							<option value="F">外出开会</option>
							<option value="L">内部会议</option>
						</select>
						<em class="text-danger"></em>
					</div>
				</div>

				<div id="main_content">

					<div class="form-group">
						<label class="col-sm-3 control-label no-padding-right" for="content"> 会议名称:<strong class="text-danger">*</strong></label>

						<div class="col-sm-9">
							<input type="text" name="content" placeholder="" class="col-xs-10 col-sm-5" />
							<em class="text-danger"></em>
						</div>
					</div>

					<div class="form-group">				
						<label class="col-sm-3 control-label no-padding-right" for="begin_time"> 会议时间:<strong class="text-danger">*</strong> </label>
						<div class="col-sm-8">
							<input type="text" name="begin_time" id='begin_time' class="datetime-picker col-xs-10 col-sm-5" data-date-format="yyyy-mm-dd hh:ii" value="{$start}">
							<em class="text-danger"></em>
						</div>
					</div>

					<div class="form-group" id="end_time_div">				
						<label class="col-sm-3 control-label no-padding-right" for="end_time"> 结束时间:<strong class="text-danger">*</strong> </label>
						<div class="col-sm-8">
							<input type="text" name="end_time" id="end_time" class="datetime-picker col-xs-10 col-sm-5" data-date-format="yyyy-mm-dd hh:ii" value="{$end}">
							<em class="text-danger"></em>
						</div>
					</div>

					<div class="form-group" id="local_place_div">
						<label class="col-sm-3 control-label no-padding-right" for="local_place"> 会议地点:<strong class="text-danger">*</strong></label>

						<div class="col-sm-9" id="local_place_select_div">
							<select class="col-xs-10 col-sm-5" id="local_place" name="local_place">
								<option value=""></option>
								<foreach name="rooms" item="room">
									<option value="{$room.id}">{$room.name}</option>
								</foreach>
							</select>
							<em class="text-danger"></em>
						</div>
					</div>

					<div class="form-group" id="foreign_place_div">
						<label class="col-sm-3 control-label no-padding-right" for="foreign_place"> 会议地点:<strong class="text-danger">*</strong></label>

						<div class="col-sm-9">
							<input type="text" name="foreign_place" placeholder="" class="col-xs-10 col-sm-5" />
							<em class="text-danger"></em>
						</div>
					</div>

					<div class="form-group">
						<label class="col-sm-3 control-label no-padding-right" for="host"> 主持人:</label>

						<div class="col-sm-9">
							<input type="text" name="host" placeholder="" class="col-xs-10 col-sm-5" />
						</div>
					</div>

					<div class="form-group">
						<label class="col-sm-3 control-label no-padding-right" for="departments"> 参加处室:<strong class="text-danger">*</strong></label>

						<div class="col-sm-9">
							<foreach name="departments" item="department">
								<label>
									<input name="departments[]" id="departments" type="checkbox" class="ace group" value="{$department.id}"/>
									<span class="lbl"> {$department.short_name}</span>
								</label>
							</foreach>
							<em class="text-danger"></em>
						</div>
					</div>

					<div class="form-group" id="person_div">
						<label class="col-sm-3 control-label no-padding-right" for="participants"> 参加人员:<strong class="text-danger">*</strong></label>

						<div class="col-sm-9" id="participants_div">
							<select multiple='' class='width-40 chosen-select tag-input-style' id='participants' name='participants[]' data-placeholder='请选择参会人员...'>
								<option value=''>&nbsp;</option>
							</select>
							<em class="text-danger"></em>
						</div>
					</div>

					<div class="form-group">
						<label class="col-sm-3 control-label no-padding-right" for="participants"> &nbsp;</label>

						<div class="col-sm-9">
							<label>
								<input name="create_schedule" id="create_schedule" type="checkbox" class="ace" value="1" />
								<span class="lbl"> 生成领导日程</span>
							</label>
						</div>
					</div>

					<div class="row">
						<div class="clearfix form-actions">
							<div class="col-md-offset-3 col-md-9">
								<button class="btn btn-info" type="submit">
									<i class="icon-ok bigger-110"></i>
									保存
								</button>

								&nbsp; &nbsp; &nbsp;
								<a class="btn" type="button" href="{:U('Reception/addReception')}">
									<i class="icon-undo bigger-110"></i>
									返回
								</a>
							</div>
						</div>
					</div>

				</div> <!-- main_content -->

			</form>
		</div>	
	</div>
	
</block>

<block name="page_js">
	<script src="__JS__/jquery-ui.custom.min.js"></script>
	<script src="__JS__/jquery.ui.touch-punch.min.js"></script>
	<script src="__JS__/chosen.jquery.min.js"></script>
	<script src="__JS__/date-time/bootstrap-datetimepicker.min.js"></script>
	<script src="__JS__/date-time/locales/bootstrap-datetimepicker.zh-CN.js"></script>
	<script src="__JS__/jquery.form.min.js"></script>
	<script src="__JS__/jquery.validate.min.js"></script>
	<script src="__JS__/messages_zh.min.js"></script>
	<script src="__JS__/bootbox.min.js"></script>
	<script src="__JS__/date-time/moment.min.js"></script>
</block>

<block name="inline_js">
	<script type="text/javascript">
		jQuery(function($){
			
			//初始化datetime控件
			$('.datetime-picker').datetimepicker({
				format:'yyyy-m-d h:ii',
				autoclose:true,
				todayBtn:true,
				language:'zh-CN',
			});
			//初始化chosen控件
			$(".chosen-select").chosen();
			// $(window).on('resize.chosen', function() {
			// 	var w = $('.chosen-select').parent().width();
			// 	$('.chosen-select').next().css({'width':w});
			// }).trigger('resize.chosen');
			//设置指示标位置
			setSidebarActive('reception_root', 'reception_meeting_add');

			// 初始化界面
			$('#main_content').hide();
			//$('#person_div').hide();

			// 选择会议性质
			$('#meeting_type').on('change', function(){
				if(this.value=='F'){
					$('#end_time_div').hide();
					$('#local_place_div').hide();
					$('#foreign_place_div').show();
					$('#main_content').show();
				}
				else if(this.value=='L'){
					$('#end_time_div').show();
					$('#local_place_div').show();
					$('#foreign_place_div').hide();
					$('#main_content').show();
				}
				else
					$('#main_content').hide();
			});

			// 会议室选择事件
			$('#local_place').on('change', function(){
				if(this.value){
					$('#conflict_meeting').remove();
					checkTimeConflict(this.value, $('#begin_time').val(), $('#end_time').val());
				}
			});

			// 选择参会人员
			
			$("input[name='departments[]']").on('click', function(){
				var ids = [];
				$('#departments:checked').each(function(){
					ids.push($(this).val());
				});
				
				createParticipants(ids);
			});

			// 领导日程生成
			$('#create_schedule').on('click', function(){
				if(this.checked){
					var $participants = $('#participants option:selected');
					if(!$participants.length){
						bootbox.alert("请先选择参会人员！");
						this.checked = false;
					}
				}
			});

			//表单验证设置
			$('#meetingform').validate({
				rules:{
					type: "required",
					content: "required",
					begin_time: "required",
					end_time:{
						required: function(){
							return $('#meeting_type').val()=='L';
						}
					},
					local_place:{
						required: function(){
							return $('#meeting_type').val()=='L';
						}
					},
					foreign_place:{
						required: function(){
							return $('#meeting_type').val()=='F';
						}
					},
					
				},//rules end
				errorPlacement: function(error, element){
					var next = element.next();
					
					if(element.attr('name')=='departments[]'){
						next = element.parent().next('em');
					}
					error.appendTo(next);
				}
			});

			//处理表单的提交
			$('#meetingform').ajaxForm({
				beforeSubmit: showRequest,
				success: showResponse,
				clearForm: false,
				dataType: 'json'
			});



		});


		// 检查房间时间是否有冲突
		function checkTimeConflict(roomId, startTime, endTime){
			$.get("{:U('Reception/checkTimeConflict')}", {id:roomId, start:startTime, end:endTime}, function(data, textStatus){
				if(data!=-1){
					
						
					var liTag = "<li class='text-danger'>";
					var html = "<div class='col-sm-12' id='"+"conflict_meeting"+"'><label class='col-sm-12 text-danger'>注意，以下时间段存在冲突：</label><ul class='col-sm-12'>";											
					$.each(data, function(n, item){
						var start = getTime(item['start']);
						var end = getTime(item['end']);
						var tempLi = liTag+start+"-"+end+"&nbsp;&nbsp;&nbsp;"+item['content']+"</li>";
						html += tempLi;
					});
					html += "</ul></div>";
					
					// $('#local_place_div').append($(html));
					$(html).appendTo($('#local_place_select_div'));
					
				}
			}, 'json');
		}

		// 表单验证
		function showRequest(formData, jqForm, options){
			//radio无法验证，单独处理
			if($('#meetingform').valid()){
				var departments = $("input[name='departments[]']").fieldValue();
				if(!departments.length){
					bootbox.alert('请选择参会处室');
					return false;
				}

				var participants = $("select.chosen-select").fieldValue();
				if(!participants.length){
					bootbox.alert('请选择参会人员！');
					return false;
				}
			}
		}

		function showResponse(responseText, statusText, xhr, $form){
			if(responseText==1){
				alert('保存成功！');
				window.location.href = "{:U('Reception/addMeeting')}";
			}
			else{
				bootbox.alert(responseText);
			}
		} 

		function createParticipants(Ids){
			//注意：Ids是个数组
			//$('#person_div').hide();
			//$('#participants').empty();
			
			$('select#participants').empty();
			// 注意：对于boolean型变量，统一用0:表示false, 1表示true
			$.get("{:U('Reception/getReceptionist')}", {id:Ids, exceptLeader:0}, function(data){
				var html = "<option value=''>&nbsp;</option>";
				var node = "<option class='col-xs-10 col-sm-5' value='";
				$.each(data, function(n, person){
					var tmpOption = node+person.id+"'>"+person.first_name+person.last_name+"</option>";
					html += tmpOption;
				});	
				
				$('select#participants').append($(html));
				//注意，必须要重新初始化，不然chosen无法显示
				$("select#participants").trigger("chosen:updated");
				
			}, 'json');
		}

		function getTime(timeStr){
			return moment(timeStr).format('H:mm');
			//return timeStr;
		}

		function isTimeConflict(start, end, wantStart, wantEnd){
			return moment(wantStart).isBefore(moment(end))&&moment(start).isBefore(moment(wantEnd));
		}
	</script>
</block>
